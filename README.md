# yamdb_final
yamdb_final


# api_yamdb
> Проект содержит три приложения: reviews, api, users. Приложение reviews содержит модели сервиса, приложение api предоставляет доступ к моделям через API, а в приложениии users реализована вся логика для управления ролями и выдачи доступов: пермишены, эндпоинты для регистрации и получения токена. Подробное описание запросов доступно по адресу /redoc/

## Локальное развертывание приложения
Создать и активировать виртуальное окружение.
- Для MacOS и Linux
```
... Dev/infra_actions$ python3 -m venv venv && . venv/bin/activate
```
- Для Windows
```
... Dev/infra_actions$ python -m venv venv && . venv/bin/activate
```
В виртуальном окружении, в директории /api_yamdb/api_yamdb/ выполнить команды:
```
pip install -r requirements.txt
python manage.py migrate
python manage.py runserver
```

## Приложение users
В приложении реализована расширенная модель пользователя, права для управления доступами до основных эндпоинтов и API для управления пользователями.

### Роли
- Аноним — может просматривать описания произведений, читать отзывы и комментарии.
- Аутентифицированный пользователь (user) — может, как и Аноним, читать всё, дополнительно он может публиковать отзывы и ставить оценку произведениям (фильмам/книгам/песенкам), может комментировать чужие отзывы; может редактировать и удалять свои отзывы и комментарии. Эта роль присваивается по умолчанию каждому новому пользователю.
- Модератор (moderator) — те же права, что и у Аутентифицированного пользователя плюс право удалять любые отзывы и комментарии.
- Администратор (admin) — полные права на управление всем контентом проекта. Может создавать и удалять произведения, категории и жанры. Может назначать роли пользователям.
- Суперюзер Django — обладет правами администратора (admin)

### Эндпоинты

- /auth/singup/ — регистрация нового пользователя
- /auth/token/ — получение токена

Алгоритм регистрации пользователя устроен следующим образом:
1. Пользователь отправляет username и email с помощью POST-запроса.
2. Стандартным генератором Django PasswordResetTokenGenerator генерируется токен, который отправляется на почту пользователя. Этот токен нужен для получения JWT-токена, с которым пользователь будет обращаться к основным эндпоинтам сервиса.
3. Пользователь отправляет username и токен в поле confirmation_code с помощью POST-запроса и получает в ответе JWT-токен, если данные валидны.

- /users/ — коллекция пользователей, обрабатывает все запросы кроме PUT
- /users/me/ — эндпоинт для получения и изменения данных о самом себе

## Приложение reviews
### Модели
В приложении реализованы модели для следующих ресурсов API YaMDb:
- Category - категории (типы) произведений (например: «Фильмы», «Книги», «Музыка»);
- Genre - жанры произведений, одно произведение может быть привязано к нескольким жанрам;
- Title - произведения, к которым пишут отзывы (определённый фильм, книга или песенка);
- Review - отзывы на произведения, отзыв привязан к определённому произведению;
- Comment - комментарии к отзывам, комментарий привязан к определённому отзыву;
- GenreTitle - модель для связи произведений к жанрам.

### Примеры запросов и ответов при работе с аутентификацией(JSON):
- Регистрация нового пользователя:
Получить код подтверждения на переданный email.
Права доступа: Доступно без токена.
Использовать имя 'me' в качестве username запрещено.
Поля email и username должны быть уникальными.
```
POST
http://localhost/api/v1/auth/signup/

{
  "email": "string",
  "username": "string"
}
```
- Получение JWT-токена
```
POST
Request:
http://localhost/api/v1/auth/token/
{
  "username": "string",
  "confirmation_code": "string"
}

Response:
{
  "token": "string"
}

```
### Примеры запросов к приложению на примере с названиями произведений (titles) (JSON):
Произведения, к которым пишут отзывы (определённый фильм, книга или песенка).
- Получение списка всех произведений:
Права доступа: Доступно без токена.
```
GET
http://localhost/api/v1/titles/

Response:
[
  {
    "count": 0,
    "next": "string",
    "previous": "string",
    "results": [
      {
        "id": 0,
        "name": "string",
        "year": 0,
        "rating": 0,
        "description": "string",
        "genre": [
          {
            "name": "string",
            "slug": "string"
          }
        ],
        "category": {
          "name": "string",
          "slug": "string"
        }
      }
    ]
  }
]
```

- Добавить новое произведение.
Права доступа: Администратор.
Потребуется jwt-token
Нельзя добавлять произведения, которые еще не вышли (год выпуска не может быть больше текущего).
При добавлении нового произведения требуется указать уже существующие категорию и жанр.
````
POST
http://localhost/api/v1/titles/
{
  "name": "string",
  "year": 0,
  "description": "string",
  "genre": [
    "string"
  ],
  "category": "string"
}

Response:
{
  "id": 0,
  "name": "string",
  "year": 0,
  "rating": 0,
  "description": "string",
  "genre": [
    {
      "name": "string",
      "slug": "string"
    }
  ],
  "category": {
    "name": "string",
    "slug": "string"
  }
}
````


#### Все примеры обращений к эндпоинтам можно посмотреть по адресу http://localhost:8000/redoc/ после развертывания проекта на своей локальной машине.


### Загрузка тестовых данных
В проекте API YaMDb в директории /api_yamdb/static/data подготовлены несколько файлов в формате csv с тестовым контентом для ресурсов Users, Titles, Categories, Genres, Review и Comments.
Для загрузки данных выполните в терминале management-команду:
```
py manage.py convert_csv_to_sqlite
```

# infra_sp2
> Проект api_yamdb настроен для работы в среде Docker.

### Шаблон наполнения env-файла:
В директории infra необходимо создать файл .env с настройкой переменных окружения для работы с базой данных (БД)
```
DJANGO_KEY='your Django secret key' # указываем секретный ключ Джанго проекта из файла settings.py
DB_ENGINE=django.db.backends.postgresql # указываем, что работаем с postgresql
DB_NAME=postgres # имя базы данных
POSTGRES_USER=postgres # логин для подключения к базе данных
POSTGRES_PASSWORD=001postgres # пароль для подключения к БД (установите свой)
DB_HOST=db # название сервиса (контейнера)
DB_PORT=5432 # порт для подключения к БД
```

## Команды для запуска приложения в контейнерах
- Для загрузки проекта на локальный компьютер выполните команду с указанием тега:
```
sudo docker pull vitaliykr89/infra_sp2:<версия тега>
```
- Обращение без тега к самой последней версии образа:
```
sudo docker pull vitaliykr89/infra_sp2:latest
```
- Запуск проекта
из директории с проектом выполнить команду:
```
sudo docker-compose up -d
```
для пересборки проекта выполнить команду с параметром --build:
```
sudo docker-compose up -d --build
```
- ##### Далее необходимо
- выполнить миграции:
```
sudo docker-compose exec web python manage.py migrate
```
- Создать суперпользователя:
```
sudo docker-compose exec web python manage.py createsuperuser
```
- Собрать статику:
```
sudo docker-compose exec web python manage.py collectstatic --no-input
```
- При необходимости создать дамп (резервную копию) БД:
```
sudo docker-compose exec web python manage.py dumpdata > fixtures.json
```
- Загрузить в БД данные из файла fixtures.json:
```
sudo docker-compose exec web python manage.py loaddata fixtures.json
```
